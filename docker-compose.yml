version: "3.2"
services:
    webserver:
        container_name: gym_addressbook
        image: gym_addressbook
        build:
            context: .
        restart: always
        ports:
            - "127.0.0.1:8380:80"
        networks:
          gymnet:
            ipv4_address: 172.23.1.2
    database:
        container_name: gym_database
        image: mariadb
        restart: always
        environment:
            MYSQL_DATABASE: gym
            MYSQL_USER: ${MYSQL_DB_USER}
            MYSQL_PASSWORD: ${MYSQL_DB_PASSWORD}
            MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
        volumes:
            - db:/var/lib/mysql
        networks:
          gymnet:
            ipv4_address: 172.23.1.3

    mysql-cron-backup:
        container_name: gym_database_cron_backup
        image: fradelg/mysql-cron-backup
        depends_on:
          - database
        volumes:
          - ${MYSQL_BACKUP_PATH}/db_backup:/backup
        networks:
          mediawiki:
            ipv4_address: 172.23.1.4
        environment:
          - MYSQL_HOST=172.23.1.3
          - MYSQL_USER=${MYSQL_DB_USER}
          - MYSQL_PASS=${MYSQL_DB_PASSWORD}
          - MAX_BACKUPS=10
          - INIT_BACKUP=0
          - TZ="Europe/Berlin"
          # Every day at 03:00
          - CRON_TIME=0 20 * * *
          # Make it small
          - GZIP_LEVEL=9
          # As of MySQL 8.0.21 this is needed
          - MYSQLDUMP_OPTS=--no-tablespaces
        restart: unless-stopped

networks:
  gymnet:
    ipam:
      config:
        - subnet: 172.23.1.0/24
volumes:
    db:
